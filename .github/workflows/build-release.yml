name: Package and Release

on:
  workflow_dispatch:
  push:
    branches: [main]

permissions:
  contents: write

jobs:
  build-release:
    runs-on: ubuntu-latest

    steps:
      - name: 🚚 检出代码
        uses: actions/checkout@v4

      - name: 📦 打包并发布多目录版本
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TZ: Asia/Shanghai
        run: |
          echo "💡 开始打包多目录版本..."

          # 定义目录映射
          declare -A PACKAGES=(
            ["wechat"]="元·微信·绿"
          )

          # 获取仓库名称作为项目名
          REPO_NAME="${{ github.repository }}"
          PROJECT_NAME="${REPO_NAME#*/}"

          # 生成标准版本号
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            # 手动触发：正式版本 v1.0.0.20241124
            VERSION="v1.0.0.$(date +%Y%m%d)"
            RELEASE_TYPE="正式版"
          else
            # 自动触发：开发版本 v1.0.0.20241124-beta
            VERSION="v1.0.0.$(date +%Y%m%d)-beta"
            RELEASE_TYPE="测试版"
          fi

          echo "🏷️ 生成版本号: ${VERSION} (${RELEASE_TYPE})"

          # 创建发布说明
          RELEASE_NOTES="## ${PROJECT_NAME} ${VERSION} ${RELEASE_TYPE}； **发布日期**: $(date +"%Y年%m月%d日 %H:%M")； ### 📦 包含内容"
          # 打包每个目录
          ZIP_FILES=()
          for SOURCE_DIR in "${!PACKAGES[@]}"; do
            TARGET_NAME="${PACKAGES[$SOURCE_DIR]}"
            ZIP_FILE="${TARGET_NAME}.zip"

            echo "📦 正在打包: ${SOURCE_DIR} -> ${ZIP_FILE}"

            if [ -d "${SOURCE_DIR}" ]; then
              # 创建压缩包
              zip -9qr "${ZIP_FILE}" "${SOURCE_DIR}"/
              echo "✅ ${ZIP_FILE} 打包完成"

              # 记录文件
              ZIP_FILES+=("${ZIP_FILE}")

              # 添加到发布说明
              RELEASE_NOTES+="- **${ZIP_FILE}**: ${TARGET_NAME} 配置包\n"
            else
              echo "⚠️ 目录 ${SOURCE_DIR} 不存在，跳过"
            fi
          done

          RELEASE_NOTES+="### 🔄 更新日志；- 自动构建于提交: \`${{ github.sha }}\` ； - 包含 ${#ZIP_FILES[@]} 个配置包"
          # 检查是否有打包成功的文件
          if [ ${#ZIP_FILES[@]} -gt 0 ]; then
            echo "🚀 正在创建 GitHub Release..."
            # 创建发布
            gh release create "${VERSION}" \
              "${ZIP_FILES[@]}" \
              --title "${PROJECT_NAME} ${VERSION} ${RELEASE_TYPE}" \
              --notes "${RELEASE_NOTES}"
            echo "✅ 发行版 ${VERSION} 创建成功！"
            # 清理临时文件
            echo "🧹 正在清理打包文件..."
            rm -f ./*.zip
            echo "✅ 清理完成"
          else
            echo "❌ 没有找到任何可打包的目录，跳过发布"
            exit 1
          fi
