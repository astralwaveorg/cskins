name: Build and Release Packages

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  PACKAGE_MAPPINGS: |
    wechat:元·微信·绿
    # 添加更多皮肤

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Process all packages
      id: process-packages
      run: |
        echo "ZIP_FILES=" > zip_files.txt
        
        echo "$PACKAGE_MAPPINGS" | while IFS=: read -r source_dir target_name; do
          if [[ -z "$source_dir" || "$source_dir" == \#* ]]; then
            continue
          fi
          
          echo "Processing: $source_dir -> $target_name"
          
          if [ -d "$source_dir" ]; then
            mv "$source_dir" "$target_name"
            echo "Renamed $source_dir to $target_name"
            
            zip_file="${target_name}.zip"
            zip -r "$zip_file" "$target_name/"
            echo "Created $zip_file"
            
            echo "ZIP_FILES=$ZIP_FILES $zip_file" >> zip_files.txt
          else
            echo "Warning: Directory $source_dir not found, skipping"
          fi
        done
        
        source zip_files.txt
        echo "zip_files<<EOF" >> $GITHUB_OUTPUT
        echo "$ZIP_FILES" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
      
    - name: Create Release
      uses: softprops/action-gh-release@v1
      if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
      with:
        files: ${{ steps.process-packages.outputs.zip_files }}
        name: Release ${{ github.sha }}
        tag_name: ${{ github.sha }}
        body: |
          - 提交: ${{ github.sha }}
          - 时间: ${{ github.event.head_commit.timestamp }}
          - 包含的包: ${{ env.PACKAGE_MAPPINGS }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
